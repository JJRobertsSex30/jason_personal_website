import{_ as E}from"./preload-helper.BlTxHScW.js";async function k(){const b=document.querySelectorAll("[data-experiment-id]"),r=new Set;b.forEach(c=>{const a=c.dataset.experimentId;a&&r.add(a)});for(const c of r)try{const a=await fetch(`/api/analytics?experimentId=${c}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!a.ok){console.error(`Failed to fetch analytics for experiment ${c}:`,a.statusText),x(c);continue}const t=await a.json();y(c,t)}catch(a){console.error(`Error fetching analytics for experiment ${c}:`,a),x(c)}}function y(b,r){document.querySelectorAll(`[data-experiment-id="${b}"]`).forEach(a=>{const t=a,i=t.dataset.metric;if(!i)return;let e="N/A",n="text-slate-800 dark:text-slate-200";switch(i){case"total-impressions":e=r.totalImpressions?.toLocaleString()||"0";break;case"total-conversions":e=r.totalConversions?.toLocaleString()||"0";break;case"overall-rate":e=r.overallRate?`${r.overallRate.toFixed(1)}%`:"0%",n=r.overallRate>5?"text-green-600 dark:text-green-400":"text-slate-800 dark:text-slate-200";break;case"avg-time-on-page":e=r.avgTimeOnPage?`${Math.round(r.avgTimeOnPage)}s`:"N/A";break;case"top-country":e=r.topCountry||"N/A";break;case"country-count":e=r.countryCount?.toString()||"0";break;case"best-country":e=r.bestCountry||"N/A";break;case"top-device":e=r.topDevice||"N/A";break;case"top-browser":e=r.topBrowser||"N/A";break;case"mobile-percentage":e=r.mobilePercentage?`${r.mobilePercentage.toFixed(1)}%`:"N/A";break;case"avg-scroll":e=r.avgScroll?`${r.avgScroll.toFixed(1)}%`:"N/A";break;case"bounce-rate":e=r.bounceRate?`${r.bounceRate.toFixed(1)}%`:"N/A",n=r.bounceRate>70?"text-red-600 dark:text-red-400":"text-green-600 dark:text-green-400";break;case"return-visitors":e=r.returnVisitors?.toLocaleString()||"0";break;case"top-utm-source":e=r.topUtmSource||"Direct";break;case"top-utm-campaign":e=r.topUtmCampaign||"N/A";break;case"direct-traffic":e=r.directTraffic?`${r.directTraffic.toFixed(1)}%`:"N/A";break;case"sample-size":e=r.sampleSize?.toLocaleString()||"0";break;case"significance-status":e=r.isSignificant?"Significant":"Not Significant",n=r.isSignificant?"text-green-600 dark:text-green-400":"text-orange-600 dark:text-orange-400";break}t.textContent=e,t.className=t.className.replace(/text-\w+-\d+/g,"")+` ${n}`})}function x(b){document.querySelectorAll(`[data-experiment-id="${b}"][data-metric]`).forEach(c=>{c.textContent="Error",c.className=c.className.replace(/text-\w+-\d+/g,"")+" text-red-500 dark:text-red-400"})}function S(){k(),document.querySelectorAll(".manage-variants-btn").forEach(a=>{const t=a;t.addEventListener("click",()=>{const i=t.dataset.experimentId;if(!i)return;const e=document.getElementById(`manage-variants-section-${i}`),n=t.getAttribute("aria-expanded")==="true";if(e){e.classList.toggle("hidden"),t.setAttribute("aria-expanded",String(!n)),t.textContent=n?"Manage Variants":"Hide Variants";const o=new URL(window.location.href);n?(o.searchParams.delete("openExperiment"),window.history.pushState({path:o.href},"",o.pathname+o.search+o.hash)):(o.searchParams.set("openExperiment",i),window.history.pushState({path:o.href},"",o.pathname+o.search+o.hash))}})});const r=new URLSearchParams(window.location.search).get("openExperiment");if(r){const a=document.getElementById(`manage-variants-section-${r}`),t=document.querySelector(`.manage-variants-btn[data-experiment-id="${r}"]`);a&&a.classList.remove("hidden"),t&&(t.setAttribute("aria-expanded","true"),t.textContent="Hide Variants")}document.querySelectorAll(".edit-experiment-btn").forEach(a=>{const t=a;t.addEventListener("click",()=>{const i=t.dataset.experimentId;if(!i)return;const e=document.querySelector(`.experiment-display-section-${i}`),n=document.querySelector(`.experiment-actions-section-${i}`),o=document.querySelector(`.experiment-edit-form-section-${i}`);if(e&&e.classList.add("hidden"),n&&n.classList.add("hidden"),o){o.classList.remove("hidden");const d=o.querySelector('input[name="experiment_name"]');d&&d.focus()}})}),document.querySelectorAll(".cancel-edit-experiment-btn").forEach(a=>{const t=a;t.addEventListener("click",()=>{const i=t.dataset.experimentId;if(!i)return;const e=document.querySelector(`.experiment-display-section-${i}`),n=document.querySelector(`.experiment-actions-section-${i}`),o=document.querySelector(`.experiment-edit-form-section-${i}`);e&&e.classList.remove("hidden"),n&&n.classList.remove("hidden"),o&&o.classList.add("hidden")})}),document.querySelectorAll(".edit-variant-btn").forEach(a=>{const t=a;t.addEventListener("click",()=>{if(!t.dataset.variantId)return;const e=t.closest(".variant-item");if(!e)return;const n=e.querySelector(".variant-display-section"),o=e.querySelector(".variant-edit-form-section");n&&n.classList.add("hidden"),o&&o.classList.remove("hidden")})}),document.querySelectorAll(".cancel-edit-variant-btn").forEach(a=>{const t=a;t.addEventListener("click",()=>{if(!t.dataset.variantId)return;const e=t.closest(".variant-item");if(!e)return;const n=e.querySelector(".variant-display-section"),o=e.querySelector(".variant-edit-form-section");n&&n.classList.remove("hidden"),o&&o.classList.add("hidden")})}),document.querySelectorAll(".delete-variant-form").forEach(a=>{const t=a;t.addEventListener("submit",i=>{i.preventDefault();const e=t.dataset.variantName||"this variant",n=document.getElementById("delete-variant-confirmation-modal"),o=document.getElementById("variant-modal-description"),d=document.getElementById("confirm-delete-variant-btn"),s=document.getElementById("cancel-delete-variant-btn");if(n&&o&&d&&s){o.textContent=`Are you sure you want to delete "${e}"? This action cannot be undone, especially if the variant has impressions.`,n.classList.remove("hidden");const g=()=>{t.submit(),f()},m=()=>{f()},f=()=>{n.classList.add("hidden"),d.removeEventListener("click",g),s.removeEventListener("click",m),n.removeEventListener("click",v),document.removeEventListener("keydown",h)},v=p=>{p.target===n&&m()},h=p=>{p.key==="Escape"&&m()};d.addEventListener("click",g),s.addEventListener("click",m),n.addEventListener("click",v),document.addEventListener("keydown",h)}})}),document.querySelectorAll(".delete-experiment-form").forEach(a=>{const t=a;t.addEventListener("submit",i=>{i.preventDefault();const e=t.dataset.experimentName||"this experiment",n=document.getElementById("delete-confirmation-modal"),o=document.getElementById("modal-description"),d=document.getElementById("confirm-delete-btn"),s=document.getElementById("cancel-delete-btn");if(n&&o&&d&&s){o.textContent=`Are you sure you want to delete "${e}"? This action will permanently remove the experiment and all its associated variants, impressions, and conversion data. This action cannot be undone.`,n.classList.remove("hidden");const g=()=>{t.submit(),f()},m=()=>{f()},f=()=>{n.classList.add("hidden"),d.removeEventListener("click",g),s.removeEventListener("click",m),n.removeEventListener("click",v),document.removeEventListener("keydown",h)},v=p=>{p.target===n&&m()},h=p=>{p.key==="Escape"&&m()};d.addEventListener("click",g),s.addEventListener("click",m),n.addEventListener("click",v),document.addEventListener("keydown",h)}})});const c=document.querySelectorAll(".chart-container");c.length>0&&E(async()=>{const{default:a}=await import("./auto.IOqTu9vY.js");return{default:a}},[]).then(({default:a})=>{c.forEach(t=>{const i=t,e=i.dataset.experimentId;if(!e){console.error("Chart container missing experiment ID");return}const n=i.querySelector(`canvas#chart-${e}`);if(!n)return;let o=[];try{const s=i.dataset.variants;if(s)o=JSON.parse(s);else return}catch(s){console.error("Failed to parse variants data for chart:",s);return}const d=o.filter(s=>typeof s.rate=="number");if(d.length>0){const s=d.map(l=>`${l.name} (Imp: ${l.impressions??0}, Conv: ${l.conversions??0}, Rate: ${(l.rate??0).toFixed(1)}%)`),g=d.map(l=>l.rate??0),m=d.length,f=[{r:54,g:162,b:235},{r:255,g:99,b:132},{r:255,g:206,b:86},{r:75,g:192,b:192},{r:153,g:102,b:255},{r:255,g:159,b:64}],v=[],h=[];for(let l=0;l<m;l++){const u=f[l%f.length];v.push(`rgba(${u.r}, ${u.g}, ${u.b}, 0.6)`),h.push(`rgba(${u.r}, ${u.g}, ${u.b}, 1)`)}const p=a.getChart(n);p&&p.destroy(),new a(n,{type:"pie",data:{labels:s,datasets:[{label:"Conversion Rate (%)",data:g,backgroundColor:v,borderColor:h,borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top",labels:{boxWidth:20,font:{size:10}}},tooltip:{callbacks:{label:function(l){let u=l.label||"";return u&&(u+=": "),l.parsed!==null&&typeof l.parsed=="number"&&(u+=l.parsed.toFixed(2)+"%"),u}}}}}})}else{const s=a.getChart(n);s&&s.destroy()}})}).catch(a=>{console.error("Failed to load Chart.js dynamically:",a)})}typeof document<"u"&&document.addEventListener("astro:page-load",S);

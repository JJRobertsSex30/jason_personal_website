---
import Layout from '~/layouts/PageLayout.astro';
import HeroCustomAB from '~/components/widgets/HeroCustomAB.astro';

// Import your A/B testing logic - ABVariant for type, getVariant for function
import { getVariant, type ABVariant } from '~/lib/abTester';
import imgHeroMain from '~/assets/images/jj2.png'; // Default image for fallback or if not in variant

// --- METADATA (can be same as index.astro or simplified) ---
const metadata = {
  title: 'A/B Test Page | JJ Roberts',
  description: "Testing A/B variations.",
};

// Fetch the chosen variant content asynchronously
// We specify the experiment name, e.g., "heroHeadlineTest"
// Ensure this experiment name exists in your 'experiments' table and has variants defined with config_json containing 'headline' and 'subheadline'.
const chosenHeroContent: ABVariant = await getVariant('Hero Headline AB Test 1');

// Image can either be part of the variant's config_json or a static default like this.
// If you want the image to be A/B tested, it should be part of the config_json in your variants table,
// and then extracted in abTester.ts similar to headline/subheadline.
const heroImageForWidget = { 
  src: imgHeroMain, // Default or fallback image
  alt: chosenHeroContent.raw_config_json?.image_alt || 'JJ Roberts - Relationship Expert' // Example: get alt from config or default
};
// If image source itself is from config:
// const imageSrcFromConfig = chosenHeroContent.raw_config_json?.image_src; // you would need to resolve this path or use a full URL

---

<Layout metadata={metadata}>
  <main>
    {/* --- HERO WIDGET (A/B Tested) --- */}
    {/* 
      IMPORTANT: You'll need to ensure your HeroCustomAB component can accept 
      `headline` and `subheadline` as props and uses them.
      It also needs to call `trackConversion` from abTester.ts on successful form submission.
      You might want to create a copy of HeroCustomAB (e.g., HeroCustomABTest.astro) 
      and modify that copy for this test, then use it here.
    */}
    <HeroCustomAB 
      headline={chosenHeroContent.headline}
      subheadline={chosenHeroContent.subheadline}
      image={heroImageForWidget}
      abTestVariantKey={chosenHeroContent.id}
    />

    {/* You can add a notice for testing if needed */}
    {Astro.cookies.has('astro_developer_toolbar') && (
      <div class="fixed bottom-0 right-0 bg-yellow-300 text-black p-2 m-4 rounded shadow-lg text-xs z-50">
        <p><strong>A/B Test Active</strong></p>
        <p>Experiment: heroHeadlineTest</p>
        <p>Variant ID: {chosenHeroContent.id}</p>
        <p>Variant Name: {chosenHeroContent.name}</p>
        <p>Headline: {chosenHeroContent.headline}</p>
      </div>
    )}

    {/* Add other sections from your original index.astro if you want them on this test page */}
    {/* For example: */}
    {/* <Features ... /> */}
    {/* <Testimonials ... /> */}

  </main>
</Layout>

<script>
  // Client-side conversion tracking is handled within HeroCustomAB.astro.
  // It calls window.trackConversion, which is set up by abTester.ts.
  // Ensure your variants in the database (config_json) have 'headline' and 'subheadline' fields.
</script> 
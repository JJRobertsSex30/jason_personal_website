---
import Layout from '~/layouts/PageLayout.astro';

// --- METADATA ---
const metadata = {
  title: 'Sex 3.0 Relationship Map Quiz | JJ Roberts',
  description: "Take the Sex 3.0 Relationship Map Quiz to understand where you are on your journey and unlock personalized insights.",
};

// --- QUIZ DATA ---
interface Question {
  text: string;
  scoring: number[];
}

interface QuizResult {
  range: [number, number];
  title: string;
  description: string;
  color: string;
}

const quizQuestions: Question[] = [
  {
    text: "Jealousy in a relationship is a sign of how much you love someone.",
    scoring: [5, 4, 3, 2, 1], // 1-5 maps to 5-1 points (Sex 2.0)
  },
  {
    text: "A healthy relationship requires constant effort and hard 'work'.",
    scoring: [5, 4, 3, 2, 1],
  },
  {
    text: "The concept of 'The One' is a realistic ideal for finding a life partner.",
    scoring: [5, 4, 3, 2, 1],
  },
  {
    text: "It is natural for human beings to be monogamous for their entire lives.",
    scoring: [5, 4, 3, 2, 1],
  },
  {
    text: "Love should be unconditional in a committed relationship.",
    scoring: [5, 4, 3, 2, 1],
  },
  {
    text: "A relationship is successful if it lasts a lifetime.",
    scoring: [5, 4, 3, 2, 1],
  },
  {
    text: "Compromise is essential for a healthy relationship.",
    scoring: [5, 4, 3, 2, 1],
  },
  {
    text: "You should share everything with your partner.",
    scoring: [5, 4, 3, 2, 1],
  },
  {
    text: "A relationship should complete you as a person.",
    scoring: [5, 4, 3, 2, 1],
  },
  {
    text: "You should be willing to sacrifice your happiness for your partner's.",
    scoring: [5, 4, 3, 2, 1],
  },
  {
    text: "A relationship requires exclusivity to be meaningful.",
    scoring: [5, 4, 3, 2, 1],
  },
  {
    text: "If you truly love someone, you should be willing to change for them.",
    scoring: [5, 4, 3, 2, 1],
  },
  {
    text: "A relationship should be your top priority in life.",
    scoring: [5, 4, 3, 2, 1],
  },
  {
    text: "You should be able to predict your partner's needs without them telling you.",
    scoring: [5, 4, 3, 2, 1],
  },
  {
    text: "A relationship should be effortless if it's with the right person.",
    scoring: [1, 2, 3, 4, 5],
  },
  {
    text: "You should always put your partner's needs before your own.",
    scoring: [5, 4, 3, 2, 1],
  },
  {
    text: "A relationship should fulfill all your emotional needs.",
    scoring: [5, 4, 3, 2, 1],
  },
  {
    text: "You should be willing to give up your dreams for your relationship.",
    scoring: [5, 4, 3, 2, 1],
  },
  {
    text: "A relationship should be free of conflict to be healthy.",
    scoring: [1, 2, 3, 4, 5],
  },
  {
    text: "You should be willing to tolerate bad behavior if you love someone.",
    scoring: [5, 4, 3, 2, 1],
  },
  {
    text: "Society's expectations significantly influence my relationship choices.",
    scoring: [5, 4, 3, 2, 1],
  },
  {
    text: "I believe in the concept of 'soulmates' or 'the one'.",
    scoring: [5, 4, 3, 2, 1],
  },
  {
    text: "Jealousy is a natural and healthy part of love.",
    scoring: [5, 4, 3, 2, 1],
  },
  {
    text: "Relationships should be built on complete honesty, even when it's difficult.",
    scoring: [1, 2, 3, 4, 5],
  },
  {
    text: "Mutual reward is the fundamental basis of any relationship.",
    scoring: [1, 2, 3, 4, 5],
  }
];

// Results interpretation
const results: QuizResult[] = [
  {
    range: [0, 25],
    title: 'Relationship 3.0 Thinker',
    description: 'You have a modern, evolved perspective on relationships that aligns with Sex 3.0 principles. You value freedom, honesty, and mutual growth in your connections.',
    color: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
  },
  {
    range: [26, 50],
    title: 'Transitioning to 3.0',
    description: 'You\'re questioning traditional relationship norms and moving toward a more liberated approach. You understand many Sex 3.0 concepts but may still hold some conventional beliefs.',
    color: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
  },
  {
    range: [51, 75],
    title: 'Balanced Perspective',
    description: 'You have a mix of traditional and modern views on relationships. You see value in both conventional relationship structures and more liberated approaches.',
    color: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
  },
  {
    range: [76, 100],
    title: 'Traditional Relationship Thinker',
    description: 'Your views align with conventional relationship norms. You might find value in exploring alternative perspectives that could lead to more freedom and fulfillment in your connections.',
    color: 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200',
  },
];

// Calculate the result based on the score
const getResult = (score: number): QuizResult | undefined => {
  const percentage = (score / (quizQuestions.length * 5)) * 100;
  return results.find(r => percentage >= r.range[0] && percentage <= r.range[1]);
};



// Get URL parameters
// eslint-disable-next-line @typescript-eslint/no-unused-vars
const url = new URL(Astro.request.url);

// Handle form submission
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const email = formData.get('email');
  const answers = JSON.parse(formData.get('answers')?.toString() || '[]') as number[];
  
  // Calculate score
  const score = answers.reduce((sum, answer, index) => {
    return sum + (quizQuestions[index]?.scoring[answer - 1] || 0);
  }, 0);
  
  const result = getResult(score);
  
  try {
    // Here you would typically send this data to your email service
    // For example, using a serverless function or API endpoint
    // This is a placeholder for the actual implementation
    const response = await fetch('https://your-email-service.com/api/subscribe', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, answers, score, result })
    });
    
    if (!response.ok) throw new Error('Failed to submit form');
    
    // Redirect with success state
    return Astro.redirect(`/quiz?email_submitted=true&score=${score}`);
  } catch (error) {
    console.error('Error submitting form:', error);
    return Astro.redirect('/quiz?error=submission_failed');
  }
}

// Get score from URL if present (used in template)

// --- SCORE RANGES AND RESULTS ---
// Max possible score: 20 questions * 5 points/question = 100
// Min possible score: 20 questions * 1 point/question = 20
// Let's create a few ranges:
// 20-40 (Mostly 2.0), 41-60 (Mixed/Aware), 61-80 (Leaning 3.0), 81-100 (Mostly 3.0)

const scoreRanges = [
  {
    maxScore: 40,
    type: 'Mostly Sex 2.0',
    summary: 'Your score indicates you are largely operating within the traditional Sex 2.0 framework. You likely hold many common societal beliefs about love, relationships, and commitment, which can often lead to unnecessary conflict, jealousy, and confusion. But awareness is the first step to change. The good news is that the blueprint for a better way exists.'
  },
  {
    maxScore: 60,
    type: 'Sex 2.0 with Growing Awareness',
    summary: 'Your responses show a mix of traditional Sex 2.0 beliefs and a growing awareness that something isn\'t quite right with the conventional map. You may feel the friction and frustration caused by outdated paradigms. This position is fertile ground for change! You are ready to explore a new framework that aligns more closely with your true nature and leads to less suffering.'
  },
  {
    maxScore: 80,
    type: 'Leaning Towards Sex 3.0',
    summary: 'You are strongly aligned with the core principles of Sex 3.0! You likely value honesty, freedom, and mutual reward over societal expectations and the need for control. You\'ve probably experienced the limitations of the Sex 2.0 firsthand. You are well on your way to building truly authentic and joyful connections based on a more natural and empowering understanding of human relationships.'
  },
  {
    maxScore: 100, // Represents 81-100
    type: 'Mostly Sex 3.0',
    summary: 'Wow! Your score indicates you already resonate strongly with the Sex 3.0 paradigm. You fundamentally understand that relationships thrive on mutual reward, honesty, trust, and respect, not on outdated notions of ownership or societal pressure. You are likely already navigating relationships with greater clarity and less suffering. You are a pioneer in building connections that are natural, free, and deeply fulfilling.'
  }
];

// Get result summary based on score (used in template)
// This function is used in the template
// eslint-disable-next-line @typescript-eslint/no-unused-vars
function getResultSummary(score: number) {
  for (const range of scoreRanges) {
    if (score <= range.maxScore) {
      return range;
    }
  }
  return scoreRanges[scoreRanges.length - 1]; // Fallback for scores outside expected range
}

// Result will be used in the template
---

<Layout metadata={metadata}>
  <div class="container mx-auto px-4 py-16 md:py-24">

    <div id="quiz-container" class="max-w-3xl mx-auto bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 md:p-8 lg:p-10">

      <h1 class="text-3xl md:text-4xl font-bold text-center text-brand-green mb-8">Your Relationship Map Quiz</h1>

      {/* Progress Bar and Counter */}
      <div class="mb-8">
        <div class="flex justify-between items-center mb-2">
          <span id="question-counter" class="text-sm font-medium text-orange-500">Answered 0 of 25 questions</span>

        </div>
        <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
          <div id="progress-bar" class="bg-orange-500 h-2.5 rounded-full transition-all duration-300 ease-in-out" style="width: 5%"></div>
        </div>
      </div>

      {/* Quiz Form */}
      <form id="quiz-form" class="space-y-8">
        {quizQuestions.map((question, index) => (
          <div class="mb-6 p-6 bg-white dark:bg-slate-700 rounded-lg shadow">
            <p class="text-lg font-medium text-gray-800 dark:text-white mb-4">{index + 1}. {question.text}</p>
            <div class="grid grid-cols-5 gap-4 md:grid-cols-5 sm:grid-cols-1">
              {['Strongly Disagree', 'Disagree', 'Neutral', 'Agree', 'Strongly Agree'].map((option, optionIndex) => (
                <div class="flex flex-col items-center">
                  <div class="flex items-center">
                    <input 
                      type="radio"
                      id={`q${index}-opt${optionIndex + 1}`}
                      name={`question-${index}`}
                      value={optionIndex + 1}
                      class="h-4 w-4 text-orange-500 border-gray-300 focus:ring-orange-500 dark:bg-slate-700 dark:border-slate-600"
                      required
                      onclick="updateQuizProgress()"
                    />
                  </div>
                  <label for={`q${index}-opt${optionIndex + 1}`} class="mt-1 text-sm text-center text-gray-700 dark:text-gray-300">
                    {option}
                  </label>
                </div>
              ))}
            </div>
          </div>
        ))}
        
        <div class="mt-8 text-center">
          <button 
            id="show-email-form-btn"
            type="button" 
            class="inline-flex items-center justify-center gap-2 px-8 py-3 bg-orange-500 hover:bg-orange-600 text-white text-lg font-semibold rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 whitespace-nowrap"
          >
            Calculate My Results
          </button>
        </div>
      </form>

      {/* Email Gate Section (Initially hidden) */}
      <div id="email-gate-area" class="hidden text-center">
        <h2 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white mb-4">Unlock Your Results!</h2>
        <p id="score-preview" class="text-lg text-gray-700 dark:text-gray-300 mb-6"></p> {/* e.g., "Your score indicates you're leaning..." */}
        <p class="text-lg text-gray-700 dark:text-gray-300 mb-6">Enter your email below to see your personalized Sex 3.0 Relationship Map result and unlock free chapters of the book.</p>

        <form id="quiz-email-form" class="flex flex-col sm:flex-row gap-4 justify-center max-w-md mx-auto">
          <label for="quiz-email-input" class="sr-only">Email address</label>
          <input
            type="email"
            id="quiz-email-input"
            name="email"
            placeholder="your.email@example.com"
            required
            class="w-full sm:w-auto flex-grow px-4 py-3 rounded-md border border-gray-300 dark:border-gray-600 bg-white/90 dark:bg-gray-800/90 text-gray-900 dark:text-white focus:ring-2 focus:ring-orange-500 focus:outline-none placeholder-gray-500 dark:placeholder-gray-400"
          />
          <button
            type="submit"
            class="px-8 py-3 bg-orange-500 hover:bg-orange-600 text-white text-lg font-semibold rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 whitespace-nowrap"
          >
            See My Results
          </button>
        </form>
         <p id="quiz-form-message" class="text-sm text-gray-600 dark:text-gray-400 mt-4"></p>
      </div>

      {/* Results Section (Initially hidden) */}
      <div id="results-area" class="hidden">
        <h2 id="result-type-heading" class="text-2xl md:text-3xl font-bold text-center text-brand-green mb-4"></h2>
        <p id="result-summary-text" class="text-lg text-gray-800 dark:text-white text-center mb-6"></p>
        <p class="text-base text-gray-700 dark:text-gray-300 text-center italic">Check your email! We've sent you a confirmation link. Once confirmed, you'll receive another email to unlock your free chapters of the book, which will help you continue your journey.</p>
        <div class="mt-8 text-center">
           {/* Optional: Button to go back to homepage or another resource */}
           <a href="/" class="inline-flex items-center justify-center gap-2 px-8 py-3 bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-gray-800 dark:text-white text-lg font-semibold rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 whitespace-nowrap">
             Back to Homepage
           </a>
        </div>
      </div>

    </div>

  </div>

  <script is:inline>
    // --- Referral Tracking ---
    const queryParams = new URLSearchParams(window.location.search);
    const referrerId = queryParams.get("ref");
    console.log('Referral ID from URL:', referrerId);
    if (referrerId) {
      localStorage.setItem("referrer_id", referrerId);
      console.log('Stored referral ID in localStorage:', referrerId);
    } else {
      console.log('No referral ID found in URL');
    }

    // Automatically check all 'strongly agree' options for testing
    const stronglyAgreeOptions = document.querySelectorAll('input[type="radio"][value="5"]');
    stronglyAgreeOptions.forEach(option => {
      option.checked = true;
    });

    // Get DOM elements
    const progressBar = document.getElementById('progress-bar');
    const questionCounter = document.getElementById('question-counter');
    const quizForm = document.getElementById('quiz-form');
    const emailGateArea = document.getElementById('email-gate-area');
    const scorePreview = document.getElementById('score-preview');
    const quizEmailForm = document.getElementById('quiz-email-form');
    const quizEmailInput = document.getElementById('quiz-email-input');
    const quizFormMessage = document.getElementById('quiz-form-message');
    const resultsArea = document.getElementById('results-area');
    const resultTypeHeading = document.getElementById('result-type-heading');
    const resultSummaryText = document.getElementById('result-summary-text');

    // Update progress based on how many questions have been answered
    function updateProgress() {
      // Count how many questions have been answered
      const answeredQuestions = Array.from(document.querySelectorAll('input[type="radio"]:checked'));
      const uniqueQuestionNames = new Set();
      
      answeredQuestions.forEach(radio => {
        uniqueQuestionNames.add(radio.name);
      });
      
      const answeredCount = uniqueQuestionNames.size;
      const totalQuestions = 25; // Total number of questions
      
      // Update the progress bar
      const progress = (answeredCount / totalQuestions) * 100;
      progressBar.style.width = `${progress}%`;
      questionCounter.textContent = `Answered ${answeredCount} of ${totalQuestions} questions`;
    }

    // Add event listeners to all radio buttons when DOM is fully loaded
    document.addEventListener('DOMContentLoaded', () => {
      // Initial update
      updateProgress();
      
      // Add change event listeners to all radio buttons
      document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', updateProgress);
      });
    });
    
    // Also add direct event listeners to ensure they work immediately
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
      radio.addEventListener('click', updateProgress);
    });

    // Handle show email form button click
    document.getElementById('show-email-form-btn').addEventListener('click', () => {
      // Check if all questions are answered
      const totalQuestions = 25;
      const answeredQuestions = document.querySelectorAll('input[type="radio"]:checked');
      const uniqueQuestionNames = new Set();
      
      answeredQuestions.forEach(radio => {
        uniqueQuestionNames.add(radio.name);
      });
      
      const answeredCount = uniqueQuestionNames.size;
      
      if (answeredCount < totalQuestions) {
        alert(`Please answer all questions. You've answered ${answeredCount} of ${totalQuestions} questions.`);
        return;
      }
      
      // Calculate score
      const formData = new FormData(quizForm);
      let totalScore = 0;
      
      // Get all form values and calculate score based on the scoring system in the questions array
      for (let i = 0; i < 25; i++) {
        const value = parseInt(formData.get(`question-${i}`));
        if (!isNaN(value)) {
            // Sex 3.0 questions (direct scoring)
            totalScore += value; // 1,2,3,4,5 points for 1,2,3,4,5 answers
        }
      }
      
      // Store score in a global variable for access by email form
      window.quizTotalScore = totalScore;
      
      // Show email gate with score preview
      quizForm.classList.add('hidden');
      emailGateArea.classList.remove('hidden');
      
      // Determine result type based on score
      let resultType = '';
      if (totalScore <= 40) {
        resultType = 'Mostly Sex 2.0';
      } else if (totalScore <= 60) {
        resultType = 'Sex 2.0 with Growing Awareness';
      } else if (totalScore <= 80) {
        resultType = 'Leaning Towards Sex 3.0';
      } else {
        resultType = 'Mostly Sex 3.0';
      }
      
      scorePreview.textContent = `Your score (${totalScore}/100) indicates you are ${resultType}.`;
      
      // Scroll to email gate
      emailGateArea.scrollIntoView({ behavior: 'smooth' });
    });

    // Handle email form submission
    quizEmailForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = quizEmailInput.value.trim();
      
      if (!email) {
        quizFormMessage.textContent = 'Please enter a valid email address.';
        quizFormMessage.className = 'text-red-600 dark:text-red-400';
        return;
      }
      
      // Show loading state
      const submitButton = quizEmailForm.querySelector('button[type="submit"]');
      
      const originalButtonText = submitButton.innerHTML;
      submitButton.disabled = true;
      submitButton.innerHTML = 'Processing...';
      
      try {
        // Get the score from the global variable
        const totalScore = window.quizTotalScore;
        
        // Get the result type from the score preview text
        const scoreText = scorePreview.textContent;
        const resultType = scoreText.match(/you are (.+)\./)[1];
        
        // FIRST: Immediately show results without waiting for email confirmation
        emailGateArea.classList.add('hidden');
        resultsArea.classList.remove('hidden');
        
        // Set result heading
        resultTypeHeading.textContent = `Your Relationship Map Type: ${resultType}`;
        
        // THEN: Prepare data for submission to Kit email integration
        const formData = new FormData();
        formData.append('email', email);
        formData.append('score', totalScore);
        formData.append('resultType', resultType);
        
        // Get referral ID from localStorage (already stored when URL parameter was detected)
        const referrerId = localStorage.getItem('referrer_id');
        console.log('Referral ID from localStorage:', referrerId);
        if (referrerId) {
          formData.append('referrer_id', referrerId);
          console.log('Appending referral ID to form data:', referrerId);
        } else {
          console.log('No referral ID found in localStorage');
        }
        
        // Log the form data for debugging
        console.log('Form data being sent:', {
          email,
          score: totalScore,
          resultType
        });
        
        // Send data to server in the background (no await)
        fetch('/api/quiz-submit', {
          method: 'POST',
          body: formData
        }).then(response => {
          console.log('Server response:', response.status, response.statusText);
          return response.json();
        }).then(data => {
          console.log('Server response data:', data);
        }).catch(error => {
          console.error('Error sending email:', error);
          // We don't need to show this error to the user since they already have their results
        });
        
        // Set appropriate summary based on result type
        let summary = '';
        if (resultType.includes('Mostly Sex 2.0')) {
          summary = 'Your score indicates you are largely operating within the traditional Sex 2.0 framework. You likely hold many common societal beliefs about love, relationships, and commitment, which can often lead to unnecessary conflict, jealousy, and confusion. But awareness is the first step to change! The good news is that the blueprint for a better way exists.';
        } else if (resultType.includes('Growing Awareness')) {
          summary = 'Your responses show a mix of traditional Sex 2.0 beliefs and a growing awareness that something isn\'t quite right with the conventional map. You may feel the friction and frustration caused by outdated paradigms. This position is fertile ground for change! You are ready to explore a new framework that aligns more closely with your true nature and leads to less suffering.';
        } else if (resultType.includes('Leaning Towards')) {
          summary = 'You are strongly aligned with the core principles of Sex 3.0! You likely value honesty, freedom, and mutual reward over societal expectations and the need for control. You\'ve probably experienced the limitations of the Sex 2.0 map firsthand. You are well on your way to building truly authentic and joyful connections based on a more natural and empowering understanding of human relationships.';
        } else {
          summary = 'Wow! Your score indicates you already resonate strongly with the Sex 3.0 paradigm. You fundamentally understand that relationships thrive on mutual reward, honesty, trust, and respect, not on outdated notions of ownership or societal pressure. You are likely already navigating relationships with greater clarity and less suffering. You are a pioneer in building connections that are natural, free, and deeply fulfilling.';
        }
        
        resultSummaryText.textContent = summary;
        
        // Scroll to results
        resultsArea.scrollIntoView({ behavior: 'smooth' });
        
      } catch (error) {
        console.error('Error submitting form:', error);
        quizFormMessage.textContent = 'An error occurred. Please try again.';
        quizFormMessage.className = 'text-red-600 dark:text-red-400';
      } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonText;
      }
    });

    // Initialize progress bar
    updateProgress();
  </script>
</Layout>
